<!DOCTYPE html>
<html lang="es">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photobook - Boda</title>

    <style>
        body {
            margin: 0;
            background: black;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #000;
        }

        video,
        canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #flash {
            position: absolute;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        button {
            background: white;
            border: none;
            padding: 18px 22px;
            border-radius: 50%;
            font-size: 20px;
            box-shadow: 0 0 10px #fff;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div id="container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div id="flash"></div>

        <div class="controls">
            <button id="btnPhoto">üì∏</button>
            <button id="btnVideo">üé•</button>
            <button id="btnStop" style="display:none;">‚èπÔ∏è</button>
        </div>
    </div>

    <script>
        let video = document.getElementById("video");
        let canvas = document.getElementById("canvas");
        let flash = document.getElementById("flash");
        let recorder;
        let chunks = [];

        // Abrir c√°mara trasera
        navigator.mediaDevices.getUserMedia({
            video: { facingMode: { exact: "environment" } },
            audio: true
        }).then(stream => {
            video.srcObject = stream;
        }).catch(err => {
            navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            }).then(stream => video.srcObject = stream);
        });

        // Flash simulado
        function activateFlash() {
            flash.style.opacity = "1";
            setTimeout(() => flash.style.opacity = "0", 150);
        }

        // Tomar foto PNG
        document.getElementById("btnPhoto").onclick = async () => {
            activateFlash();

            let w = video.videoWidth;
            let h = video.videoHeight;

            canvas.width = w;
            canvas.height = h;

            let ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0, w, h);

            let dataURL = canvas.toDataURL("image/png"); // PNG

            // enviar al backend
            await fetch("https://script.google.com/macros/s/AKfycbyzdi5N7zNiMr8q0uSpCyLTbVZMER4owMSKZbY30-KM-oE0Z-emr6ioVYFzSKS09iyv/exec", {
                method: "POST",
                body: dataURL.replace("data:image/png;base64,", "")
            });

            alert("Foto PNG subida a Drive");
        };

        // Grabar video (webm ‚Üí opcionalmente convertir a mp4)
        document.getElementById("btnVideo").onclick = () => {
            chunks = [];
            let stream = video.srcObject;

            recorder = new MediaRecorder(stream, {
                mimeType: "video/webm"
            });

            recorder.ondataavailable = e => chunks.push(e.data);

            recorder.onstop = async () => {
                let blob = new Blob(chunks, { type: "video/webm" });

                let reader = new FileReader();
                reader.onloadend = async () => {
                    let base64 = reader.result.split(",")[1];

                    await fetch("https://script.google.com/macros/s/AKfycbzepAoe966JPGbmP6xKMgqjsCOu6bw9FtwiPPzpa1gfAX7VdAiQel6WGGGp4Ssvd1xGgQ/exec", {
                        method: "POST",
                        body: base64
                    });

                    alert("üé• Video subido a Drive");
                };
                reader.readAsDataURL(blob);
            };

            recorder.start();
            document.getElementById("btnStop").style.display = "inline-block";
            document.getElementById("btnVideo").style.display = "none";
        };

        // Detener video
        document.getElementById("btnStop").onclick = () => {
            recorder.stop();
            document.getElementById("btnStop").style.display = "none";
            document.getElementById("btnVideo").style.display = "inline-block";
        };
    </script>

</body>

</html>