<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Nuestra Boda ‚Äî C√°mara</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Montserrat:wght@500;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg1: #0e0e10;
            --bg2: #1b1b1f;
            --gold: #d4af37;
            --gold-2: #f6e27a;
            --btn-bg: rgba(0, 0, 0, 0.55);
            --btn-fg: #fff;
        }

        html, body {
            margin: 0;
            height: 100%;
            background: linear-gradient(160deg, var(--bg1), var(--bg2));
            color: #fff;
            font-family: Montserrat, system-ui;
        }

        .wrap {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
        }

        header {
            text-align: center;
            padding: 10px;
            pointer-events: none;
        }

        header h1 {
            margin: 0;
            font-size: 22px;
            font-family: Cinzel, serif;
            background: linear-gradient(45deg, var(--gold), var(--gold-2));
            -webkit-background-clip: text;
            color: transparent;
            text-shadow: 0 0 12px rgba(212,175,55,.25);
        }

        .videoBox {
            position: relative;
            flex: 1;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
            position: absolute;
        }

        .frame {
            position: absolute;
            inset: 0;
            margin: auto;
            aspect-ratio: 9/16;
            width: min(100vw, 56.25vh);
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 22px;
            box-shadow: 0 0 0 999vmax rgba(0,0,0,.25) inset;
        }

        .controls {
            position: absolute;
            bottom: 16px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .btn {
            border: none;
            background: var(--btn-bg);
            color: var(--btn-fg);
            border-radius: 50px;
            padding: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(6px);
        }

        .btn--round {
            width: 70px;
            height: 70px;
        }

        #fullscreenBtn {
            position: absolute;
            right: 12px;
            top: 12px;
            background: rgba(0,0,0,.45);
        }

        .toast {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,.65);
            padding: 10px 15px;
            border-radius: 12px;
            display: none;
        }

        .toast.show {
            display: block;
        }
    </style>
</head>

<body>
<div class="wrap">
    <header>
        <h1>Andrey üíñ Yazmin ‚Ä¢ 22 Nov</h1>
    </header>

    <button id="fullscreenBtn" class="btn">
        ‚õ∂
    </button>

    <div class="videoBox">
        <video id="preview" playsinline autoplay muted></video>
        <div class="frame"></div>
    </div>

    <div class="controls">
        <button class="btn" id="flashBtn">‚ö°</button>
        <button class="btn btn--round" id="photoBtn">üì∏</button>
        <button class="btn btn--round" id="recBtn">üé•</button>
        <button class="btn btn--round" id="stopBtn" style="display:none;">‚èπ</button>
        <button class="btn" id="galleryBtn">üñºÔ∏è</button>
    </div>

    <div class="toast" id="toast">Listo</div>
</div>

<script>

const UPLOAD_ENDPOINT = "https://script.google.com/macros/s/AKfycbzZdBcimeBMiMm1u5DwubWKSybsDL1LS7xLY2pkutQYxArI8BKb2-fw93uM1XfpuLYQ/exec";

const video = document.getElementById("preview");
const flashBtn = document.getElementById("flashBtn");
const photoBtn = document.getElementById("photoBtn");
const recBtn = document.getElementById("recBtn");
const stopBtn = document.getElementById("stopBtn");
const galleryBtn = document.getElementById("galleryBtn");
const fullscreenBtn = document.getElementById("fullscreenBtn");
const toast = document.getElementById("toast");

let stream, mediaRecorder, chunks = [];
let torchSupported = false, torchOn = false;
let mimeChosen = "";

function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2000);
}

async function initCamera() {
    stream = await navigator.mediaDevices.getUserMedia({
        video: {
            facingMode: "environment",
            width: { ideal: 1080 },
            height: { ideal: 1920 }
        },
        audio: false
    });

    video.srcObject = stream;

    // TORCH
    const track = stream.getVideoTracks()[0];
    const caps = track.getCapabilities();
    torchSupported = caps.torch || false;
}

initCamera();

// FULLSCREEN
fullscreenBtn.onclick = () => {
    document.documentElement.requestFullscreen();
};

// FLASH
flashBtn.onclick = async () => {
    const track = stream.getVideoTracks()[0];
    torchOn = !torchOn;
    await track.applyConstraints({ advanced: [{ torch: torchOn }] });
    showToast(torchOn ? "Flash encendido" : "Flash apagado");
};

// FOTO
photoBtn.onclick = async () => {
    const canvas = document.createElement("canvas");
    canvas.width = 1080;
    canvas.height = 1920;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, 1080, 1920);

    canvas.toBlob(async blob => {
        await uploadFile(blob, "foto_" + Date.now() + ".png");
    }, "image/png");
};

// VIDEO
recBtn.onclick = () => {
    chunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: "video/webm" });
        await uploadFile(blob, "video_" + Date.now() + ".webm");
    };
    mediaRecorder.start();
    recBtn.style.display = "none";
    stopBtn.style.display = "inline-flex";
};

stopBtn.onclick = () => {
    mediaRecorder.stop();
    stopBtn.style.display = "none";
    recBtn.style.display = "inline-flex";
};

// GALER√çA
const inputGallery = document.createElement("input");
inputGallery.type = "file";
inputGallery.accept = "image/*,video/*";
inputGallery.style.display = "none";
document.body.appendChild(inputGallery);

galleryBtn.onclick = () => inputGallery.click();

inputGallery.onchange = async e => {
    if (!e.target.files.length) return;
    const f = e.target.files[0];
    await uploadFile(f, "galeria_" + Date.now());
};

// UPLOAD
async function uploadFile(blob, filename) {
    showToast("Subiendo‚Ä¶");

    const base64 = await toBase64(blob);

    const res = await fetch(UPLOAD_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            filename,
            mimeType: blob.type,
            base64
        })
    });

    const data = await res.json();
    showToast(data.ok ? "Guardado en Drive" : "Error al subir");
}

function toBase64(blob) {
    return new Promise(res => {
        const r = new FileReader();
        r.onload = () => res(r.result.split(",")[1]);
        r.readAsDataURL(blob);
    });
}

</script>

</body>
</html>
