<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <title>Nuestra Boda ‚Äî C√°mara</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Montserrat:wght@500;700&display=swap"
        rel="stylesheet">

    <style>
        /* --- ESTILOS DE BODA --- */
        :root {
            --bg1: #0e0e10;
            --bg2: #1b1b1f;
            --gold: #d4af37;
            --gold2: #f6e27a;
        }

        html,
        body {
            margin: 0;
            height: 100%;
            background: linear-gradient(160deg, var(--bg1), var(--bg2));
            color: #fff;
            font-family: Montserrat;
        }

        .wrap {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column
        }

        header {
            text-align: center;
            padding: 12px 0;
            font-family: Cinzel;
            font-size: 22px
        }

        header span {
            background: linear-gradient(45deg, var(--gold), var(--gold2));
            -webkit-background-clip: text;
            color: transparent;
        }

        .videoBox {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        video {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Marco tipo Instagram */
        .frame {
            position: absolute;
            inset: 0;
            margin: auto;
            aspect-ratio: 9/16;
            width: min(100vw, 56vh);
            border: 2px solid rgba(255, 255, 255, 0.18);
            border-radius: 22px;
            box-shadow: 0 0 0 999vmax rgba(0, 0, 0, 0.25) inset;
        }

        /* Controles */
        .controls {
            position: absolute;
            bottom: 22px;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            gap: 14px;
            justify-content: center;
            align-items: center;
        }

        .row {
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: center
        }

        .btn {
            border: none;
            border-radius: 999px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.55);
            color: #fff;
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
        }

        .btn-round {
            width: 78px;
            height: 78px
        }

        .btn-gold {
            background: rgba(212, 175, 55, 0.25)
        }

        .btn-green {
            background: rgba(70, 212, 107, 0.28)
        }

        .btn-warn {
            background: rgba(255, 184, 77, 0.28)
        }

        .toast {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 14px;
            border-radius: 12px;
            opacity: 0;
            transition: 0.3s;
        }

        .toast.show {
            opacity: 1
        }

        .loader {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .loader.show {
            display: flex
        }
    </style>
</head>

<body>
    <div class="wrap">

        <header>
            <span>Andrey üíñ Yazmin ‚Äî 22 Nov</span>
        </header>

        <div class="videoBox">
            <video id="preview" autoplay playsinline muted></video>
            <div class="frame"></div>

            <div class="loader" id="loader">
                <div style="font-size:20px">‚è≥</div>
            </div>
            <div class="toast" id="toast">Listo</div>

            <div class="controls">
                <div class="row">
                    <button class="btn btn-warn" id="flashBtn" title="Flash">‚ö°</button>
                    <button class="btn btn-warn" id="galleryBtn" title="Galer√≠a">üìÅ</button>
                    <button class="btn btn-warn" id="fsBtn" title="Pantalla completa">‚õ∂</button>
                </div>

                <div class="row">
                    <button class="btn btn-gold btn-round" id="photoBtn" title="Foto">üì∏</button>
                    <button class="btn btn-green btn-round" id="recBtn" title="Grabar (30s)">üé•</button>
                    <button class="btn btn-warn btn-round" id="stopBtn" style="display:none" title="Detener">‚èπ</button>
                </div>
            </div>
        </div>

        <script>
            /* ============================ */
            /*   CONFIGURA TU SCRIPT AQU√ç   */
            /* ============================ */

            /* IMPORTANTE:
               - No usamos headers personalizados
               - No seteamos Content-Type
               - No enviamos JSON: solo FormData
            */
            const UPLOAD_URL = "https://script.google.com/macros/s/AKfycbynScgOiX2VNRdh1Hs4d9XvqVd7Ckge5AAV3BQByoF9SHO62BBRwV_nTFW5x1GKtW8P/exec";

            /* ============================ */
            /*  VARIABLES GLOBALES         */
            /* ============================ */
            let stream, mediaRecorder, chunks = [];
            let torch = false, torchOK = false;
            let recTimer = null;

            /* ============================ */
            /*      UTILIDADES UI          */
            /* ============================ */
            const toast = document.getElementById("toast");
            const loader = document.getElementById("loader");

            function showToast(msg) {
                toast.textContent = msg;
                toast.classList.add("show");
                setTimeout(() => toast.classList.remove("show"), 1800);
            }
            function setLoading(b) { loader.classList.toggle("show", b); }

            /* Helper: dibujar estilo object-fit: cover al canvas */
            function drawVideoCover(ctx, video, w, h) {
                const vw = video.videoWidth || 1280;
                const vh = video.videoHeight || 720;
                const scale = Math.max(w / vw, h / vh);
                const dw = vw * scale;
                const dh = vh * scale;
                const dx = (w - dw) / 2;
                const dy = (h - dh) / 2;
                ctx.drawImage(video, dx, dy, dw, dh);
            }

            /* ============================ */
            /*      INICIAR C√ÅMARA         */
            /* ============================ */
            (async function initCamera() {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: { ideal: "environment" },
                            width: { ideal: 1080 },
                            height: { ideal: 1920 }
                        },
                        audio: false
                    });

                    const track = stream.getVideoTracks()[0];
                    const caps = track.getCapabilities ? track.getCapabilities() : {};
                    torchOK = !!caps.torch;

                    document.getElementById("preview").srcObject = stream;

                } catch (err) {
                    console.error(err);
                    showToast("No se pudo abrir la c√°mara");
                }
            })();

            /* ============================ */
            /*       FLASH / TORCH          */
            /* ============================ */
            document.getElementById("flashBtn").onclick = async () => {
                if (!torchOK) return showToast("Flash no soportado");
                try {
                    const track = stream.getVideoTracks()[0];
                    torch = !torch;
                    await track.applyConstraints({ advanced: [{ torch }] });
                } catch (e) {
                    console.error(e);
                    showToast("No se pudo activar el flash");
                }
            };

            /* ============================ */
            /*       FULLSCREEN             */
            /* ============================ */
            document.getElementById("fsBtn").onclick = () => {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                else document.exitFullscreen();
            };

            /* ============================ */
            /*       GALER√çA INPUT          */
            /* ============================ */
            const galleryInput = document.createElement("input");
            galleryInput.type = "file";
            galleryInput.accept = "image/*"; // solo fotos, como pides
            galleryInput.style.display = "none";
            document.body.appendChild(galleryInput);

            document.getElementById("galleryBtn").onclick = () => galleryInput.click();

            galleryInput.onchange = async (e) => {
                if (!e.target.files.length) return;
                const file = e.target.files[0];
                uploadBlob(file, file.name);
            };

            /* ============================ */
            /*       TOMAR FOTO             */
            /* ============================ */
            document.getElementById("photoBtn").onclick = async () => {
                try {
                    const video = document.getElementById("preview");
                    // Asegurar tama√±o exacto 1080x1920
                    const canvas = document.createElement("canvas");
                    canvas.width = 1080; canvas.height = 1920;
                    const ctx = canvas.getContext("2d");
                    drawVideoCover(ctx, video, 1080, 1920);

                    canvas.toBlob(blob => {
                        if (!blob) { showToast("No se pudo crear la foto"); return; }
                        uploadBlob(blob, `foto_${Date.now()}.png`);
                    }, "image/png", 0.92);
                } catch (e) {
                    console.error(e);
                    showToast("Error al capturar foto");
                }
            };

            /* ============================ */
            /*       GRABAR VIDEO           */
            /* ============================ */
            document.getElementById("recBtn").onclick = () => {
                try {
                    chunks = [];
                    // Elegimos el mejor mime soportado por el dispositivo
                    const mimeCandidates = [
                        "video/webm;codecs=vp9",
                        "video/webm;codecs=vp8",
                        "video/webm"
                    ];
                    const mimeType = mimeCandidates.find(t => MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) || "";

                    mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);
                    mediaRecorder.ondataavailable = e => { if (e.data && e.data.size > 0) chunks.push(e.data); };

                    mediaRecorder.onstop = () => {
                        try {
                            const type = (mimeType && mimeType.includes("webm")) ? "video/webm" : "video/webm";
                            const blob = new Blob(chunks, { type });
                            uploadBlob(blob, `video_${Date.now()}.webm`);
                        } catch (err) {
                            console.error(err);
                            showToast("Error al crear video");
                        } finally {
                            chunks = [];
                        }
                    };

                    mediaRecorder.start();
                    // L√≠mite m√°x 30s
                    recTimer = setTimeout(() => {
                        if (mediaRecorder && mediaRecorder.state === "recording") {
                            mediaRecorder.stop();
                        }
                    }, 30000);

                    document.getElementById("recBtn").style.display = "none";
                    document.getElementById("stopBtn").style.display = "inline-flex";
                } catch (e) {
                    console.error(e);
                    showToast("No se pudo iniciar la grabaci√≥n");
                }
            };

            document.getElementById("stopBtn").onclick = () => {
                try {
                    if (recTimer) { clearTimeout(recTimer); recTimer = null; }
                    if (mediaRecorder && mediaRecorder.state === "recording") {
                        mediaRecorder.stop();
                    }
                } finally {
                    document.getElementById("recBtn").style.display = "inline-flex";
                    document.getElementById("stopBtn").style.display = "none";
                }
            };

            /* ============================ */
            /*         SUBIR ARCHIVO        */
            /* ============================ */
            async function uploadBlob(blob, filename) {
                const fd = new FormData();
                fd.append("file", blob, filename);
                fd.append("mime", blob.type || "application/octet-stream"); // requerido por tu backend como metadata opcional

                setLoading(true);
                try {
                    const res = await fetch(UPLOAD_URL, {
                        method: "POST",
                        body: fd // ‚¨ÖÔ∏è Sin headers, sin JSON, sin Content-Type manual
                    });

                    // Intentar parsear como JSON; si no, leer texto
                    let ok = false, url = "", raw = "";
                    try {
                        const data = await res.json();
                        ok = !!data.ok;
                        url = data.url || "";
                    } catch {
                        raw = await res.text();
                        ok = /"ok"\s*:\s*true/.test(raw);
                        const m = raw.match(/"url"\s*:\s*"([^"]+)"/);
                        url = m ? m[1] : "";
                    }

                    if (ok) {
                        showToast("‚úÖ Guardado en Drive");
                        console.log("URL:", url || "(sin URL)");
                    } else {
                        console.warn("Respuesta no OK del backend:", url || raw);
                        showToast("‚ùå Error guardando en Drive");
                    }

                } catch (err) {
                    console.error(err);
                    showToast("‚ö†Ô∏è Error de conexi√≥n");
                } finally {
                    setLoading(false);
                }
            }
        </script>

</body>

</html>