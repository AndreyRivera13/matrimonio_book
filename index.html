<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Nuestra Boda ‚Äî C√°mara</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Montserrat:wght@500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg1: #0e0e10;
            --bg2: #1b1b1f;
            --gold: #d4af37;
            --gold-2: #f6e27a;
            --accent: #ff7f7f;
            --ok: #46d46b;
            --warn: #ffb84d;
            --btn-bg: rgba(0, 0, 0, 0.55);
            --btn-fg: #fff;
        }

        html,
        body {
            margin: 0;
            height: 100%;
            background: linear-gradient(160deg, var(--bg1), var(--bg2));
            color: #fff;
            font-family: Montserrat, system-ui, -apple-system;
        }

        .wrap {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column
        }

        header {
            position: absolute;
            top: env(safe-area-inset-top, 16px);
            left: 0;
            right: 0;
            z-index: 3;
            text-align: center;
            padding: 8px 16px;
            pointer-events: none
        }

        header h1 {
            margin: 0;
            font-size: 22px;
            letter-spacing: 1px;
            font-family: Cinzel, serif;
            background: linear-gradient(45deg, var(--gold), var(--gold-2));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 18px rgba(212, 175, 55, 0.25)
        }

        .videoBox {
            position: relative;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden
        }

        video {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            inset: 0;
            background: #000
        }

        /* marco vertical 9:16 para que ‚Äúse vea Instagram‚Äù */
        .frame {
            position: absolute;
            inset: 0;
            margin: auto;
            aspect-ratio: 9/16;
            width: min(100vw, 56.25vh);
            max-height: 100vh;
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 22px;
            box-shadow: 0 0 0 999vmax rgba(0, 0, 0, 0.25) inset
        }

        .controls {
            position: absolute;
            bottom: env(safe-area-inset-bottom, 16px);
            left: 0;
            right: 0;
            display: flex;
            gap: 16px;
            justify-content: center;
            align-items: center;
            z-index: 3
        }

        .btn {
            appearance: none;
            border: none;
            background: var(--btn-bg);
            color: var(--btn-fg);
            border-radius: 999px;
            padding: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
            backdrop-filter: blur(6px)
        }

        .btn:active {
            transform: scale(0.98)
        }

        .btn--round {
            width: 78px;
            height: 78px
        }

        .btn--gold {
            background: linear-gradient(180deg, rgba(212, 175, 55, 0.25), rgba(212, 175, 55, 0.15))
        }

        .btn--ok {
            background: linear-gradient(180deg, rgba(70, 212, 107, 0.35), rgba(70, 212, 107, 0.2))
        }

        .btn--warn {
            background: linear-gradient(180deg, rgba(255, 184, 77, 0.35), rgba(255, 184, 77, 0.2))
        }

        .btn span {
            font-size: 12px;
            margin-left: 8px;
            font-weight: 700;
            letter-spacing: .3px
        }

        .row {
            display: flex;
            gap: 12px
        }

        .toast {
            position: absolute;
            top: calc(env(safe-area-inset-top, 16px) + 42px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.65);
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(6px);
            opacity: 0;
            transition: .25s;
            z-index: 5;
            max-width: 86vw;
            text-align: center
        }

        .toast--show {
            opacity: 1
        }

        .status {
            position: absolute;
            right: 12px;
            top: calc(env(safe-area-inset-top, 16px) + 52px);
            font-size: 12px;
            opacity: .85;
            background: rgba(0, 0, 0, 0.5);
            padding: 6px 10px;
            border-radius: 999px
        }

        .loader {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4
        }

        .loader.show {
            display: flex
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--gold);
            margin: 0 6px;
            animation: b 1s infinite
        }

        .dot:nth-child(2) {
            animation-delay: .15s
        }

        .dot:nth-child(3) {
            animation-delay: .3s
        }

        @keyframes b {

            0%,
            60%,
            100% {
                transform: scale(1);
                opacity: .5
            }

            30% {
                transform: scale(1.4);
                opacity: 1
            }
        }

        footer {
            position: absolute;
            bottom: 6px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 11px;
            opacity: .6
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header>
            <h1>Andrey üíñ Yazmin ‚Ä¢ 22 Nov</h1>
        </header>

        <div class="videoBox">
            <video id="preview" playsinline autoplay muted></video>
            <div class="frame" aria-hidden="true"></div>

            <div class="loader" id="loader" aria-live="polite">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>

            <div class="toast" id="toast">Listo</div>
            <div class="status" id="status">C√°mara: iniciando‚Ä¶</div>

            <div class="controls">
                <button class="btn btn--warn" id="flashBtn" title="Flash" aria-pressed="false">
                    <!-- icono flash -->
                    <svg width="26" height="26" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M7 2v11h3v9l7-14h-4l4-6z" />
                    </svg>
                    <span>Flash</span>
                </button>

                <div class="row">
                    <button class="btn btn--gold btn--round" id="photoBtn" title="Foto">
                        <svg width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="13" r="4" />
                            <path
                                d="M5 7h2l2-2h6l2 2h2a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2z" />
                        </svg>
                    </button>

                    <button class="btn btn--ok btn--round" id="recBtn" title="Grabar video">
                        <svg width="34" height="34" viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="12" r="8" />
                        </svg>
                    </button>

                    <button class="btn btn--warn btn--round" id="stopBtn" title="Detener" style="display:none">
                        <svg width="34" height="34" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="6" y="6" width="12" height="12" rx="2" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <footer>Hecho con üíñ para nuestra boda</footer>
    </div>

<script>

const UPLOAD_PHOTO_ENDPOINT = "https://script.google.com/macros/s/AKfycbwIb-1ysl9FZKMWaph38Ip3iCBWr7ByU_WWP2Eeffyq15ikRQB7d6wOT-Lz2PMH4sAS/exec";
const UPLOAD_VIDEO_ENDPOINT = "https://script.google.com/macros/s/AKfycbz2PwBywrCDCkbjDUxDX-l3lE0flRTMJNaBxJiVLMPYtm-7KhfKe1d3utNYtE3LHTNIfQ/exec";

// Agregar input oculto para galer√≠a
const galleryInput = document.createElement("input");
galleryInput.type = "file";
galleryInput.accept = "image/*";
galleryInput.capture = false;
galleryInput.style.display = "none";
document.body.appendChild(galleryInput);

let stream, mediaRecorder, chunks = [];
let torchSupported = false, torchOn = false;
let mimeChosen = "";

document.getElementById("galleryBtn")?.addEventListener("click", () => {
    galleryInput.click();
});

galleryInput.addEventListener("change", async (e) => {
    if (!e.target.files.length) return;
    const file = e.target.files[0];
    const blob = file;

    showToast("Subiendo foto de galer√≠a...");
    setLoading(true);

    const ok = await uploadFile(blob, "galeria_"+Date.now()+".png", UPLOAD_PHOTO_ENDPOINT);

    setLoading(false);
    showToast(ok ? "‚úÖ Foto subida" : "‚ùå Error al subir");
});

async function uploadFile(blob, filename, endpoint) {
    try {
        const mimeType = blob.type;

        // Convertir a base64
        const base64 = await blobToBase64(blob);

        const body = {
            filename,
            mimeType,
            base64
        };

        const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        if (!res.ok) return false;

        const data = await res.json();
        return data.ok === true;
    } catch (err) {
        console.error("Upload error:", err);
        return false;
    }
}

// --- FOTO DESDE LA C√ÅMARA ---
async function takePhoto() {
    try {
        setLoading(true);

        const canvas = document.createElement("canvas");
        drawCoverToCanvas(canvas, video);

        const blob = await new Promise(r => canvas.toBlob(r, "image/png", 1.0));
        const ok = await uploadFile(blob, "foto_"+Date.now()+".png", UPLOAD_PHOTO_ENDPOINT);

        setLoading(false);
        showToast(ok ? "üì∏ Foto guardada" : "‚ùå Error al subir la foto");

    } catch(e) {
        setLoading(false);
        showToast("‚ùå Error tomando foto");
    }
}

// --- VIDEO ---
async function startRecording() {
    chunks = [];
    mediaRecorder = new MediaRecorder(stream, mimeChosen ? { mimeType: mimeChosen } : {});
    mediaRecorder.ondataavailable = e => chunks.push(e.data);

    mediaRecorder.onstop = async () => {
        setLoading(true);
        const blob = new Blob(chunks, { type: mimeChosen || "video/webm" });

        const ext = blob.type.includes("mp4") ? "mp4" : "webm";
        const ok = await uploadFile(blob, "video_"+Date.now()+"."+ext, UPLOAD_VIDEO_ENDPOINT);

        setLoading(false);
        showToast(ok ? "üé• Video guardado" : "‚ùå Error subiendo video");
    };

    mediaRecorder.start();
}

// --- Base64 Helper ---
function blobToBase64(blob) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(",")[1]);
        reader.readAsDataURL(blob);
    });
}

</script>

    
</body>

</html>