<!doctype html>
<html lang="es">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nuestra Boda ‚Äî C√°mara</title>

<style>
/* --- ESTILOS --- */
body{
  margin:0;background:black;color:white;
  font-family:Arial, sans-serif;height:100vh;overflow:hidden;
}
#preview{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
.controls{
  position:absolute;bottom:20px;width:100%;display:flex;
  flex-direction:column;align-items:center;gap:14px;
}
.row{display:flex;gap:12px}
.btn{
  background:rgba(0,0,0,0.55);border:none;color:white;
  padding:16px;border-radius:50%;font-size:26px;
}
.btn-round{width:75px;height:75px}
.toast{
  position:absolute;top:30px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,0.7);padding:10px 16px;border-radius:8px;
  opacity:0;transition:.3s;
}
.toast.show{opacity:1}
.loader{
  position:absolute;inset:0;background:rgba(0,0,0,0.4);
  display:none;align-items:center;justify-content:center;font-size:32px;
}
.loader.show{display:flex}
header{
  position:absolute;top:10px;width:100%;text-align:center;
  font-size:22px;font-weight:bold;
}
</style>
</head>

<body>

<header>Andrey üíñ Yazmin ‚Äî 22 Nov</header>

<video id="preview" autoplay playsinline muted></video>

<div class="loader" id="loader">‚è≥</div>
<div class="toast" id="toast">Listo</div>

<div class="controls">
  <div class="row">
    <button class="btn" id="flashBtn">‚ö°</button>
    <button class="btn" id="galleryBtn">üñºÔ∏è</button>
    <button class="btn" id="fsBtn">‚õ∂</button>
  </div>
  <div class="row">
    <button class="btn btn-round" id="photoBtn">üì∏</button>
    <button class="btn btn-round" id="recBtn">üé•</button>
    <button class="btn btn-round" id="stopBtn" style="display:none">‚èπ</button>
  </div>
</div>

<script>
/* =============================== */
/*   CONFIGURA TU APPS SCRIPT      */
/* =============================== */
const UPLOAD_URL = "AQU√ç_TU_WEBAPP_URL";   // <<--- reemplaza esto

/* =============================== */
let stream, mediaRecorder, chunks=[];
let torch=false, torchOK=false;

function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1600);
}
function load(b){
  document.getElementById("loader").classList.toggle("show",b);
}

/* =============================== */
/*  C√ÅMARA                         */
/* =============================== */
(async()=>{
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment"},
      audio:false
    });

    const track = stream.getVideoTracks()[0];
    const caps = track.getCapabilities();
    torchOK = !!caps.torch;

    document.getElementById("preview").srcObject = stream;
  }catch(e){
    showToast("No se pudo abrir c√°mara");
  }
})();

/* =============================== */
/* FLASH                           */
/* =============================== */
document.getElementById("flashBtn").onclick=async()=>{
  if(!torchOK) return showToast("Flash no soportado");
  torch=!torch;
  await stream.getVideoTracks()[0].applyConstraints({advanced:[{torch}]});
};

/* =============================== */
/* FULLSCREEN                      */
/* =============================== */
document.getElementById("fsBtn").onclick=()=>{
  if(!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
};

/* =============================== */
/* GALER√çA                         */
/* =============================== */
const input=document.createElement("input");
input.type="file";
input.accept="image/*";
input.style.display="none";
document.body.appendChild(input);

document.getElementById("galleryBtn").onclick=()=>input.click();

input.onchange=(e)=>{
  if(e.target.files.length) sendBlob(e.target.files[0], "galeria.jpg");
};

/* =============================== */
/* FOTO                            */
/* =============================== */
document.getElementById("photoBtn").onclick=()=>{
  const v=document.getElementById("preview");
  const c=document.createElement("canvas");
  c.width=1080;c.height=1920;
  c.getContext("2d").drawImage(v,0,0,1080,1920);
  c.toBlob(b=>sendBlob(b,"foto.png"),"image/png");
};

/* =============================== */
/* VIDEO                           */
/* =============================== */
document.getElementById("recBtn").onclick=()=>{
  chunks=[];
  mediaRecorder = new MediaRecorder(stream,{mimeType:"video/webm"});
  mediaRecorder.ondataavailable=e=>chunks.push(e.data);
  mediaRecorder.onstop=()=>{
    const blob=new Blob(chunks,{type:"video/webm"});
    sendBlob(blob,"video.webm");
  };
  mediaRecorder.start();
  document.getElementById("recBtn").style.display="none";
  document.getElementById("stopBtn").style.display="inline-flex";
};

document.getElementById("stopBtn").onclick=()=>{
  mediaRecorder.stop();
  document.getElementById("recBtn").style.display="inline-flex";
  document.getElementById("stopBtn").style.display="none";
};

/* =============================== */
/* SUBIDA SIN CORS (FormData)      */
/* =============================== */
async function sendBlob(blob,filename){
  load(true);

  const fd=new FormData();
  fd.append("file", blob, filename);

  try{
    const r=await fetch(UPLOAD_URL, {method:"POST",body:fd});
    const txt=await r.text();
    load(false);

    if(txt.includes("ok")) showToast("Guardado en Drive");
    else showToast("Error al subir");
    
  }catch(e){
    load(false);
    showToast("Error de conexi√≥n");
  }
}
</script>

</body>
</html>
