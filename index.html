<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <title>Nuestra Boda ‚Äî C√°mara</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Montserrat:wght@500;700&display=swap"
        rel="stylesheet">

    <style>
        /* --- ESTILOS DE BODA --- */
        :root {
            --bg1: #0e0e10;
            --bg2: #1b1b1f;
            --gold: #d4af37;
            --gold2: #f6e27a;
        }

        html,
        body {
            margin: 0;
            height: 100%;
            background: linear-gradient(160deg, var(--bg1), var(--bg2));
            color: #fff;
            font-family: Montserrat;
        }

        .wrap {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column
        }

        header {
            text-align: center;
            padding: 12px 0;
            font-family: Cinzel;
            font-size: 22px
        }

        header span {
            background: linear-gradient(45deg, var(--gold), var(--gold2));
            -webkit-background-clip: text;
            color: transparent;
        }

        .videoBox {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        video {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Marco tipo Instagram */
        .frame {
            position: absolute;
            inset: 0;
            margin: auto;
            aspect-ratio: 9/16;
            width: min(100vw, 56vh);
            border: 2px solid rgba(255, 255, 255, 0.18);
            border-radius: 22px;
            box-shadow: 0 0 0 999vmax rgba(0, 0, 0, 0.25) inset;
        }

        /* Controles */
        .controls {
            position: absolute;
            bottom: 22px;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            gap: 14px;
            justify-content: center;
            align-items: center;
        }

        .row {
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: center
        }

        .btn {
            border: none;
            border-radius: 999px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.55);
            color: #fff;
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
        }

        .btn-round {
            width: 78px;
            height: 78px
        }

        .btn-gold {
            background: rgba(212, 175, 55, 0.25)
        }

        .btn-green {
            background: rgba(70, 212, 107, 0.28)
        }

        .btn-warn {
            background: rgba(255, 184, 77, 0.28)
        }

        .toast {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 14px;
            border-radius: 12px;
            opacity: 0;
            transition: 0.3s;
        }

        .toast.show {
            opacity: 1
        }

        .loader {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .loader.show {
            display: flex
        }

        /* Controles de zoom */
        .zoom-controls {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .zoom-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(6px);
            cursor: pointer;
        }

        .zoom-level {
            text-align: center;
            font-size: 14px;
            color: #fff;
            background: rgba(0, 0, 0, 0.6);
            padding: 6px 10px;
            border-radius: 12px;
            backdrop-filter: blur(6px);
        }
    </style>
</head>

<body>
    <div class="wrap">

        <header>
            <span>Boda Andrey & Yazmin üíñ</span>
        </header>

        <div class="videoBox">
            <video id="preview" autoplay playsinline muted></video>
            <div class="frame"></div>

            <div class="loader" id="loader">
                <div style="font-size:20px">‚è≥</div>
            </div>
            <div class="toast" id="toast">Listo</div>

            <!-- Controles de Zoom -->
            <div class="zoom-controls" id="zoomControls">
                <button class="zoom-btn" id="zoomInBtn">+</button>
                <div class="zoom-level" id="zoomLevel">1.0x</div>
                <button class="zoom-btn" id="zoomOutBtn">‚àí</button>
            </div>

            <div class="controls">
                <div class="row">
                    <button class="btn btn-warn" id="flashBtn" title="Flash">‚ö°</button>
                    <button class="btn btn-warn" id="galleryBtn" title="Galer√≠a">üìÅ</button>
                    <button class="btn btn-warn" id="fsBtn" title="Pantalla completa">‚õ∂</button>
                </div>

                <div class="row">
                    <button class="btn btn-gold btn-round" id="photoBtn" title="Foto">üì∏</button>
                    <button class="btn btn-green btn-round" id="recBtn" title="Grabar (30s)">üé•</button>
                    <button class="btn btn-warn btn-round" id="stopBtn" style="display:none" title="Detener">‚èπ</button>
                </div>
            </div>
        </div>

        <script>
            /* ============================ */
            /*   CONFIGURA TU SCRIPT AQU√ç   */
            /* ============================ */
            const UPLOAD_URL = "https://script.google.com/macros/s/AKfycbzwFzFGi4yV5Q6-yAyy1dYR_nNbvpV7Y2SSTIy_MBRdcDmeo2KtPZKtS4r5VCzWvqfr/exec";

            /* ============================ */
            /*  VARIABLES GLOBALES         */
            /* ============================ */
            let stream, mediaRecorder, chunks = [];
            let torch = false, torchOK = false;
            let recTimer = null;

            // Variables de zoom
            let currentZoom = 1;
            let minZoom = 1;
            let maxZoom = 10;
            let zoomSupported = false;

            /* ============================ */
            /*      UTILIDADES UI          */
            /* ============================ */
            const toast = document.getElementById("toast");
            const loader = document.getElementById("loader");
            const zoomLevelDisplay = document.getElementById("zoomLevel");

            function showToast(msg) {
                toast.textContent = msg;
                toast.classList.add("show");
                setTimeout(() => toast.classList.remove("show"), 1800);
            }
            function setLoading(b) { loader.classList.toggle("show", b); }

            /* Helper: dibujar estilo object-fit: cover al canvas */
            function drawVideoCover(ctx, video, w, h) {
                const vw = video.videoWidth || 1280;
                const vh = video.videoHeight || 720;
                const scale = Math.max(w / vw, h / vh);
                const dw = vw * scale;
                const dh = vh * scale;
                const dx = (w - dw) / 2;
                const dy = (h - dh) / 2;
                ctx.drawImage(video, dx, dy, dw, dh);
            }

            /* ============================ */
            /*      ZOOM FUNCTIONS         */
            /* ============================ */
            async function applyZoom(zoom) {
                if (!zoomSupported || !stream) return;

                const track = stream.getVideoTracks()[0];
                try {
                    await track.applyConstraints({
                        advanced: [{ zoom }]
                    });
                    currentZoom = zoom;
                    zoomLevelDisplay.textContent = zoom.toFixed(1) + "x";
                } catch (e) {
                    console.error("Error aplicando zoom:", e);
                }
            }

            function zoomIn() {
                const newZoom = Math.min(currentZoom + 0.5, maxZoom);
                applyZoom(newZoom);
            }

            function zoomOut() {
                const newZoom = Math.max(currentZoom - 0.5, minZoom);
                applyZoom(newZoom);
            }

            /* ============================ */
            /*      INICIAR C√ÅMARA         */
            /* ============================ */
            (async function initCamera() {
                try {
                    // Solicitar M√ÅXIMA calidad de c√°mara
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: { ideal: "environment" },
                            width: { ideal: 3840 },  // 4K
                            height: { ideal: 2160 }, // 4K
                            frameRate: { ideal: 30 }
                        },
                        audio: false
                    });

                    const track = stream.getVideoTracks()[0];
                    const caps = track.getCapabilities ? track.getCapabilities() : {};

                    torchOK = !!caps.torch;

                    // Verificar soporte de zoom
                    if (caps.zoom) {
                        zoomSupported = true;
                        minZoom = caps.zoom.min || 1;
                        maxZoom = caps.zoom.max || 10;
                        currentZoom = track.getSettings().zoom || 1;
                        zoomLevelDisplay.textContent = currentZoom.toFixed(1) + "x";
                        console.log("üîç Zoom disponible:", minZoom, "-", maxZoom);
                    } else {
                        document.getElementById("zoomControls").style.display = "none";
                        console.log("‚ö†Ô∏è Zoom no soportado");
                    }

                    // Log de resoluci√≥n real obtenida
                    const settings = track.getSettings();
                    console.log("üìπ Resoluci√≥n c√°mara:", settings.width + "x" + settings.height);

                    document.getElementById("preview").srcObject = stream;

                } catch (err) {
                    console.error(err);
                    showToast("No se pudo abrir la c√°mara");
                }
            })();

            /* ============================ */
            /*      ZOOM CONTROLS          */
            /* ============================ */
            document.getElementById("zoomInBtn").onclick = zoomIn;
            document.getElementById("zoomOutBtn").onclick = zoomOut;

            // Soporte para gestos de pinch (pellizco)
            let initialDistance = 0;
            let initialZoom = 1;

            document.getElementById("preview").addEventListener("touchstart", (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const dx = e.touches[0].pageX - e.touches[1].pageX;
                    const dy = e.touches[0].pageY - e.touches[1].pageY;
                    initialDistance = Math.sqrt(dx * dx + dy * dy);
                    initialZoom = currentZoom;
                }
            });

            document.getElementById("preview").addEventListener("touchmove", (e) => {
                if (e.touches.length === 2 && zoomSupported) {
                    e.preventDefault();
                    const dx = e.touches[0].pageX - e.touches[1].pageX;
                    const dy = e.touches[0].pageY - e.touches[1].pageY;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    const scale = distance / initialDistance;
                    const newZoom = Math.min(Math.max(initialZoom * scale, minZoom), maxZoom);
                    applyZoom(newZoom);
                }
            });

            /* ============================ */
            /*       FLASH / TORCH          */
            /* ============================ */
            document.getElementById("flashBtn").onclick = async () => {
                if (!torchOK) return showToast("Flash no soportado");
                try {
                    const track = stream.getVideoTracks()[0];
                    torch = !torch;
                    await track.applyConstraints({ advanced: [{ torch }] });
                } catch (e) {
                    console.error(e);
                    showToast("No se pudo activar el flash");
                }
            };

            /* ============================ */
            /*       FULLSCREEN             */
            /* ============================ */
            document.getElementById("fsBtn").onclick = () => {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                else document.exitFullscreen();
            };

            /* ============================ */
            /*       GALER√çA INPUT          */
            /* ============================ */
            const galleryInput = document.createElement("input");
            galleryInput.type = "file";
            galleryInput.accept = "image/*";
            galleryInput.style.display = "none";
            document.body.appendChild(galleryInput);

            document.getElementById("galleryBtn").onclick = () => galleryInput.click();

            galleryInput.onchange = async (e) => {
                if (!e.target.files.length) return;
                const file = e.target.files[0];
                uploadBlob(file, file.name);
            };

            /* ============================ */
            /*       TOMAR FOTO             */
            /* ============================ */
            document.getElementById("photoBtn").onclick = async () => {
                try {
                    const video = document.getElementById("preview");

                    // Usar la resoluci√≥n REAL del video para m√°xima calidad
                    const videoWidth = video.videoWidth || 1920;
                    const videoHeight = video.videoHeight || 1080;

                    console.log("üì∏ Capturando foto:", videoWidth + "x" + videoHeight, "Zoom:", currentZoom.toFixed(1) + "x");

                    const canvas = document.createElement("canvas");
                    canvas.width = videoWidth;
                    canvas.height = videoHeight;

                    // Sin alpha para mejor compresi√≥n
                    const ctx = canvas.getContext("2d", {
                        alpha: false,
                        desynchronized: true
                    });

                    // Dibujar sin interpolaci√≥n para m√°xima nitidez
                    ctx.imageSmoothingEnabled = false;
                    drawVideoCover(ctx, video, videoWidth, videoHeight);

                    // JPEG con 98% de calidad (casi imperceptible vs PNG pero 5x m√°s peque√±o)
                    canvas.toBlob(blob => {
                        if (!blob) { showToast("No se pudo crear la foto"); return; }
                        console.log("üíæ Tama√±o foto:", (blob.size / 1024 / 1024).toFixed(2) + " MB");
                        uploadBlob(blob, `foto_${Date.now()}.jpg`);
                    }, "image/jpeg", 0.98);
                } catch (e) {
                    console.error(e);
                    showToast("Error al capturar foto");
                }
            };

            /* ============================ */
            /*       GRABAR VIDEO           */
            /* ============================ */
            document.getElementById("recBtn").onclick = () => {
                try {
                    chunks = [];

                    // Intentar M√ÅXIMA calidad de video
                    const mimeCandidates = [
                        "video/webm;codecs=vp9",
                        "video/webm;codecs=vp8",
                        "video/webm"
                    ];

                    const mimeType = mimeCandidates.find(t =>
                        MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)
                    ) || "";

                    console.log("üé• Codec video:", mimeType);

                    // Configurar para buena calidad sin afectar rendimiento
                    const options = {
                        mimeType: mimeType || undefined,
                        videoBitsPerSecond: 2500000  // 2.5 Mbps = buena calidad sin lag
                    };

                    mediaRecorder = new MediaRecorder(stream, options);

                    mediaRecorder.ondataavailable = e => {
                        if (e.data && e.data.size > 0) chunks.push(e.data);
                    };

                    mediaRecorder.onstop = () => {
                        try {
                            const blob = new Blob(chunks, { type: mimeType || "video/webm" });
                            console.log("üíæ Tama√±o video:", (blob.size / 1024 / 1024).toFixed(2) + " MB");
                            uploadBlob(blob, `video_${Date.now()}.webm`);
                        } catch (err) {
                            console.error(err);
                            showToast("Error al crear video");
                        } finally {
                            chunks = [];
                        }
                    };

                    // Capturar en chunks m√°s peque√±os para evitar lag
                    mediaRecorder.start(1000); // Capturar cada 1 segundo

                    // L√≠mite m√°x 30s
                    recTimer = setTimeout(() => {
                        if (mediaRecorder && mediaRecorder.state === "recording") {
                            mediaRecorder.stop();
                        }
                    }, 30000);

                    document.getElementById("recBtn").style.display = "none";
                    document.getElementById("stopBtn").style.display = "inline-flex";
                } catch (e) {
                    console.error(e);
                    showToast("No se pudo iniciar la grabaci√≥n");
                }
            };

            document.getElementById("stopBtn").onclick = () => {
                try {
                    if (recTimer) { clearTimeout(recTimer); recTimer = null; }
                    if (mediaRecorder && mediaRecorder.state === "recording") {
                        mediaRecorder.stop();
                    }
                } finally {
                    document.getElementById("recBtn").style.display = "inline-flex";
                    document.getElementById("stopBtn").style.display = "none";
                }
            };

            /* ============================ */
            /*         SUBIR ARCHIVO        */
            /* ============================ */
            async function uploadBlob(blob, filename) {
                setLoading(true);
                try {
                    console.log("üì§ Subiendo:", filename, "Tama√±o:", blob.size, "bytes", "Tipo:", blob.type);

                    // Convertir blob a base64
                    const reader = new FileReader();
                    const base64Promise = new Promise((resolve, reject) => {
                        reader.onloadend = () => {
                            const result = reader.result;
                            const base64 = result.split(',')[1];
                            resolve(base64);
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });

                    const base64Data = await base64Promise;

                    // Enviar como JSON
                    const payload = {
                        filename: filename,
                        mimeType: blob.type || "application/octet-stream",
                        data: base64Data
                    };

                    const res = await fetch(UPLOAD_URL, {
                        method: "POST",
                        body: JSON.stringify(payload)
                    });

                    console.log("üì° Status HTTP:", res.status, res.statusText);

                    const rawText = await res.text();
                    console.log("üìÑ Respuesta completa:", rawText);

                    let ok = false, url = "";

                    try {
                        const data = JSON.parse(rawText);
                        ok = !!data.ok;
                        url = data.url || "";
                        console.log("‚úÖ JSON parseado:", data);
                    } catch (parseErr) {
                        console.warn("‚ö†Ô∏è No es JSON v√°lido, buscando patrones...");
                        ok = /"ok"\s*:\s*true/.test(rawText);
                        const m = rawText.match(/"url"\s*:\s*"([^"]+)"/);
                        url = m ? m[1] : "";
                    }

                    if (ok) {
                        showToast("‚úÖ Guardado en Drive");
                        console.log("üîó URL:", url || "(sin URL)");
                    } else {
                        console.error("‚ùå Respuesta no OK. Texto completo:", rawText);
                        showToast("‚ùå Error guardando en Drive");
                    }

                } catch (err) {
                    console.error("üí• Error de conexi√≥n:", err);
                    showToast("‚ö†Ô∏è Error de conexi√≥n");
                } finally {
                    setLoading(false);
                }
            }
        </script>

</body>

</html>